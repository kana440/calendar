<template id="watch-rooms">
  <v-container>
    <v-list>
      <v-btn
        @click="updateSelectedDate(selectedDate)"
        ><v-icon>refresh</v-icon></v-btn>
        <span>{{isLoading}}</span>
    </v-list>
    <v-stepper :value="step" vertical>
      <v-stepper-step
        step="1"
        :complete="step > 1"
      >
      <div @click="back">{{titleStep1}}</div>
      </v-stepper-step>
      <v-stepper-items>
        <v-stepper-content step="1">
          <v-data-table
            class="elevation-5"
            :headers="headers"
            :items="tableStep1"
            :loading="isLoading"
            hide-default-footer
            loading-text="ロード中..."
            no-data-text="予定がありません"
            :items-per-page="-1"
            @click:row="selectEvent($event)"
          >
            <v-progress-linear #progress color="blue" indeterminate></v-progress-linear>
            <template #no-data>
              予定がありません
            </template>
          </v-data-table>
        </v-stepper-content>

        <v-stepper-step
          step="2"
          :complete="step > 2"
        >会議室を選ぶ
        </v-stepper-step>

        <v-stepper-content step="2">
          <v-data-table
            v-model="selected"
            :headers="headers2"
            :items="tableStep2"
            item-key="calendarId"
            show-select
            hide-default-footer
            class="elevation-5"
          >
          </v-data-table>
          <v-btn @click='back'>戻る</v-btn>
          <v-btn @click='register'>ウォッチ登録</v-btn>
        </v-stepper-content>

        <v-stepper-content step="3">

        </v-stepper-content>
      </v-stepper-items>

      <v-stepper-step
        step="3"
        :complete="step > 3"
      >
      </v-stepper-step>

      <v-stepper-content step="3">
        <v-icon>loading</v-icon>
      </v-stepper-content>

    </v-stepper>
  </v-container>
</template>

<script>
const WatchRooms = {
  template: '#watch-rooms',
  computed: {
    ...Vuex.mapState([
      'myEvents',
      'roomsEvents',
      'user',
      'selectedEvent',
      'isLoading',
      'selectedDate',
    ]),
    ...Vuex.mapGetters([
      'validRooms',
      'roomsEventsSelectedDate',
      'calendarEventsSelectedDate',
    ]),
    step(){
      if(!this.selectedEvent) return 1
      return 2
    },
    tableStep1() {
      if(!this.calendarEventsSelectedDate){
        //ロード中
        return
      }
      switch(this.calendarEventsSelectedDate.response){
        case 'has events': {
          return this.calendarEventsSelectedDate.items.map( item => {
            // 変換を指定
            return {
              eventId: item.eventId,
              time: getTimeString(item.startTime, item.endTime),
              summary: item.summary,
              location: item.location,
              startTime: item.startTime,
              endTime: item.endTime,
              monitored: true,
              event: item,
            }
          })


        }
        case 'has no events': {

        }
        case 'access denied': {

        }
        dafault :{
          //エラー

        }
      }
    },
    titleStep1(){
      if(!this.selectedEvent) return '予定を選ぶ'
      return (
        '選択:'
        + this.selectedEvent.time + ' '
        + this.selectedEvent.summary
        )
    },
    tableStep2(){
      if(!this.selectedEvent) return []
      const results = this.roomsEventsSelectedDate.map(roomEvents=>{
        const room = this.validRooms.find(room=>room.calendarId===roomEvents.calendarId)
        switch(roomEvents.response){
          case 'has events': {
            const events = roomEvents.items.filter(event=>{
              const status = getRoomStatus(
                event,
                roomEvents.calendarId,
                state.user.email,
                this.selectedEvent.startTime,
                this.selectedEvent.endTime
              )
              if(status === 'busy' || status ==='accepted'){
                return true
              }
              return false
            }).map(event=>{
              let organizer
              if(!event.organizer) {
                organizer = '非公開'
              } else {
                organizer = event.organizer.displayName ?
                  event.organizer.displayName : event.organizer.email
              }
              return {
                time: getTimeString(event.startTime,event.endTime),
                summary: event.summary,
                organizer: organizer,
              }
            })
            if(events.length!==0){
              const event = events[0]
              return {
                calendarId: room.calendarId,
                name: room.name,
                status: 'occupied',
                time: event.time,
                summary: event.summary,
                organizer: event.organizer,
              }
            } else {
              return {
                calendarId: room.calendarId,
                name: room.name,
                status: 'available',
              }
            }
          }
          case 'has no events': {
            return {
              calendarId: room.calendarId,
              name: room.name,
              status: 'available',
            }
          }
          case 'access denied':{
            return {
              calendarId: room.calendarId,
              name: room.name,
              status: 'noAuth',
            }
          }
        }
      })
      return results
    },
  },
  data() {
    return {
      selected: [],
      loading: false,
      pagination: {
        rowsPerPage: -1,
      },

      selectedRooms: [],
      selectedEvent: null,


      headers: [{
          text: '時間',
          value: 'time',
          align: 'left',
          sortable: false,
          width: '60'
        },
        {
          text: '予定名',
          value: 'summary',
          align: 'left',
          sortable: false
        },
        {
          text: '場所',
          value: 'location',
          align: 'left',
          sortable: false
        },
        {
          text: 'ウォッチ',
          value: 'location',
          align: 'center',
          sortable: false,
          width: '60'
        },
      ],

      headers2: [{
          text: '部屋',
          value: 'name',
          align: 'left',
          sortable: false,
          width: '60'
        },
        {
          text: '空き状況',
          value: 'status',
          align: 'left',
          sortable: false,
          width: 60,
        }
        ,
        {
          text: '先約名',
          value: 'summary',
          align: 'left',
          sortable: false,
        },
        {
          text: '先約者',
          value: 'organizer',
          align: 'left',
          sortable: false,
        },
      ],


    }
  },
  methods: {
    ...Vuex.mapMutations([
      'updateSelectedEvent',
    ]),
    ...Vuex.mapActions([
      'updateSelectedDate',
      'setWatchList',
    ]),
    selectEvent(value){
      this.step = 2
      this.updateSelectedEvent(value.event)
      this.selectedEvent = value
    },
    updateSelected(value){
    },
    back() {
      this.selectedEvent = null

    },
    register() {
      if(this.selected.length===0) return
      const watchRooms = this.selected.map(room=>{
        return {
          calendarId: room.calendarId,
          name: room.name,
        }
      })

      const record ={
        subscriber: this.user.email,
        status: '01_ウォッチ中',
        eventId: this.selectedEvent.eventId,
        startTime: this.selectedEvent.startTime,
        endTime: this.selectedEvent.endTime,
        summary: this.selectedEvent.summary,
        watchRooms: watchRooms,
      }
      this.setWatchList(record)
    }
  },
}
</script>
