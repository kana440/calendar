<script>
const getters = {
  floors(state) {
    return state.rooms.map(room => room.floor).filter((value, index, self) => {
      return self.indexOf(value) === index
    })
  },
  validRooms(state) {
    return state.rooms.filter(room => {
      return room.floor === state.user.floor
      && room.validFrom <= state.selectedDate
      && room.validTo >= state.selectedDate
    })
  },
  calendarEventsSelectedDate(state){
    return state.calendarEvents.find(
      events=>equalDate(events.date, state.selectedDate)
    )
  },
  roomsEventsSelectedDate(state){
    return state.roomsEvents.filter(
      events=>equalDate(events.date, state.selectedDate)
    )
  },
  myWatchList(state){
    return state.watchList.filter(record => (
      record.status === "01_ウォッチ中"　
      && record.subscriber === state.user.email
    ))
  },
  roomsStatus(state,getters){
    return getters.roomsEventsSelectedDate.map(roomEvents=>{
      switch (roomEvents.response){
        case 'has events': {
          const events = roomEvents.items
          const cells = getters.periods.map(period=>{
            const status = {busy:[], accepted:[], declined:[]}
            events.forEach(event=>{
              const result = getRoomStatus(event,roomEvents.calendarId,state.user.email,period.from,period.to)
              if(result!=='ignore') status[result].push(event)
            })
            return status
          })
          return {
            calendarId: roomEvents.calendarId,
            name: roomEvents.name,
            response: 'has events',
            items: roomEvents.items,
            cells: cells,
          }
        }
        case 'has no events': {
          return {
            calendarId: roomEvents.calendarId,
            name: roomEvents.name,
            response: 'has no events',
          }
        }
        case 'access denied':{
          return {
            calendarId: roomEvents.calendarId,
            name: roomEvents.name,
            response: 'access denied',
          }
        }
      }
  })
  },
  periods(state){
    const hoursFrom = state.periodSetting.hoursFrom
    const hoursTo = state.periodSetting.hoursTo
    const interval = state.periodSetting.interval
    const periods = []
    const time = new Date(state.selectedDate)
    time.setHours(hoursFrom)
    for(let i=hoursFrom; i<hoursTo; i+=interval){
      let from = new Date(time)
      time.setMinutes(time.getMinutes()+interval*60)
      let to = new Date(time)
      periods.push({from,to})
    }
    return periods
  },
}
</script>
