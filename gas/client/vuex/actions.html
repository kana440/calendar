<script>
const api = {
  async getRooms(){
    const result = await this.runGas('getRooms')
    result.forEach(item => {
      item.validFrom = new Date(item.validFrom)
      item.validTo = new Date(item.validTo)
    })
    return result
  },

  async getUserSettings(){
    const result = await this.runGas('getUserSettings')
    return result
  },

  async getCalendarEvents({calendarId, selectedDate}){
    const result = await this.runGas('apiGetCalendarEvents',{
      calendarId: calendarId,
      dateString: selectedDate.toLocaleDateString(),
    })
    result.date = new Date(result.date)
    result.items.forEach(item=>{
       item.startTime = new Date(item.startTime)
       item.endTime = new Date(item.endTime)
    })
    return result
  },

  async setUserSettings({email,floor}){
    const result = await this.runGas('setUserSettings',{
      email,
      floor,
    })
  },

  async setWatchList({
    subscriber, status, eventId, startTime, endTime, summary, watchRooms
  }) {
    const result = await this.runGas('setWatchList',{
      subscriber,
      status,
      eventId,
      startTimeString: startTime.toLocaleString(),
      endTimeString: endTime.toLocaleString(),
      summary,
      watchRooms,
    })
    console.log('api result:',result)
    return result
  },

  async runGas(func,payload) {
    return await new Promise((resolve, reject) =>
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        [func](payload)
    )
  }
}

const actions = {
  async initialize({commit, dispatch, getters}){
    const [rooms, userSettings] = await Promise.all([
      api.getRooms(),
      api.getUserSettings(),
    ])
    commit('updateRooms', rooms)
    commit('updateUserSettings', userSettings)
    dispatch('getCalendarEvents')
    dispatch('getRoomEvents')

    commit('updateInitializing', false)

    // フロア情報が不明な時はダイアログを表示
    if(!getters.validRooms.length){
      commit('updateNewUser', true)
    }
  },

  async getCalendarEvents({ commit, state }) {
    const result = await api.getCalendarEvents({
      calendarId: state.user.email,
      selectedDate: state.selectedDate,
    })
    commit('updateCalendarEvents', result)
  },

  async getRoomEvents({commit, state, getters}) {
    const results = await Promise.all(
      getters.validRooms.map(room => {
        return api.getCalendarEvents({
          calendarId: room.calendarId,
          selectedDate: state.selectedDate,
        })
      })
    )
    results.forEach(result=>commit('updateRoomEvents', result))
  },

  async setUserSettings({ state, commit }){
    commit('updateNewUser', false)
    commit('updateInitializing', true)
    await api.setUserSettings(state.user)
    commit('updateInitializing', false)
  },

  async setWatchList({state, commit},{
    event,
    watchRooms,
  }){
    const result = await api.setWatchList({
      subscriber: state.user.email,
      status: '01_ウォッチ中',
      eventId: event.eventId,
      startTime: event.startTime,
      endTime: event.endTime,
      summary: event.summary,
      watchRooms: watchRooms,
    })
  },

  updateSelectedDate({ commit, dispatch }, payload) {
    commit('updateSelectedDate', payload)
    dispatch('getCalendarEvents')
    dispatch('getRoomEvents')
  },


  async updateWatchList({ commit, state },payload){
    results = await runGas('getWatchList')
    commit('updateWatchList',results)
  },

  onEventSelected({ commit }, { event }) {
    commit('selectEvent', { event })
  },
}
</script>
